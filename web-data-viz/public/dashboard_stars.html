<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="./css/style_dashboard.css" />
  </head>
  <header>
    <img class="bg-header" src="./assets/imagens/header.svg" alt="" />
    <nav>
      <div class="links-nav">
        <a href="index.html">Página Inicial</a>
        <img src="./assets/icones/linha_1.svg" alt="" />
        <a href="sobre_a_serie.html">Sobre a Série</a>
        <img src="./assets/icones/linha_1.svg" alt="" />
        <a href="dicas_estudo.html">Dicas de Estudo</a>
        <img src="./assets/icones/linha_1.svg" alt="" />
        <a href="quizz_conhecimentos.html">Quizz</a>
      </div>
      <div class="botoes-nav">
        <a href="cadastro.html">
          <img src="./assets/icones/botao_cadastro.svg" alt="" />
        </a>
        <a href="login.html">
          <img src="./assets/icones/botao_login.svg" alt="" />
        </a>
      </div>
    </nav>
  </header>
  <body>
    <div class="div-principal">
      <div class="coluna-lateral">
        <h2 class="msg-bemvindo">Bem-vindo, <span id="nome_usuario"></span></h2>
        <div>
          <img
            class="avatar"
            id="img_avatar"
            src=""
            alt=""
          />
        </div>
        <div class="texto-side">
          <div class="dia-semana">
            <h3>Hoje é:</h3>
            <h3 id="dia_semana"></h3>
          </div>
          <img src="./assets/icones/divisor.svg" alt="" />
          <h3>Citação da semana:</h3>
          <h3>"I smell Snow"</h3>
          <!-- aqui vai ser um vetor que puxa por math.random -->
          <img src="./assets/icones/divisor.svg" alt="" />
          <div class="card-individual">
            <h3>
              Ivy <br />
              League
            </h3>
            <img id="img_ivy" src="" alt="" />
          </div>
          <img src="./assets/icones/divisor.svg" alt="" />
          <div class="card-individual">
            <h3>
              Team
            </h3>
            <img class="team" id="img_team" src="" alt="" />
          </div>
          <img src="./assets/icones/divisor.svg" alt="" />
          <div onclick="limparSessao()" class="logout">
            <h3>Log-Out</h3>
            <img src="./assets/icones/logoutbutton.svg" alt="" />
          </div>
        </div>
      </div>
      <main>
        <div class="titulo-dash">
          <img src="./assets/icones/decoracao-dash.svg" alt="" />
          <h2>Dashboard</h2>
          <img
            class="rotacionar"
            src="./assets/icones/decoracao-dash.svg"
            alt=""
          />
        </div>
        <div class="cards-kpi">
          <div class="card-dash">
            <span>Maior Pontuação no Quiz</span>
            <span class="dado-banco" id="pontuacao_usuario"></span>
          </div>
         <div class="card-dash">
            <span>Média de Pontuação dos Usuários</span>
            <!-- <button onclick="test()">Teste</button> -->
            <span class="dado-banco" id="pontuacao_site"></span>
          </div>
            <div class="card-dash">
            <span>Quantidade de Tentativas no Quiz</span>
            <span class="dado-banco" id="tentativas_quiz"></span>
          </div>
        </div>
        <div class="linha-dash1">
          <canvas class="grafico-barra" id="grafico-pontuacao"></canvas>
        </div>
        <div class="linha-dash2">
          <div class="grafico-torta">
            <canvas id="grafico-ivy"></canvas>
          </div>
          <div class="grafico-torta">
            <canvas id="grafico-views"></canvas>
          </div>
        </div>
      </main>
    </div>
    <footer>
      <div>
        Design & dev: Aurora Carvalho • Gilmore Girls © Warner Bros. • Site de
        fã desenvolvido para projeto acadêmido, sem fins lucrativos e sem
        vínculo oficial.
      </div>
      <img class="icon-footer" src="./assets/icones/github_footer.svg" alt="" />
    </footer>
  </body>
</html>
<script>

  var diasSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"]

  var d = new Date()
  var diaAtual = diasSemana[d.getDay()]
  document.getElementById("dia_semana").innerHTML = diaAtual
  
  const idUsuario = sessionStorage.ID_USUARIO

  function buscarMaiorPontuacao(idUsuario){
            fetch(`/pontuacaoQuizz/Maior/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].maxima
                        console.log('kpi: ', resposta[0].maxima)
                      }

                      plotarKpiPontuacao(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }

  function buscarMediaPontuacao(idUsuario){
            fetch(`/pontuacaoQuizz/buscarPontuacaoMedia/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO}}, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].media
                        console.log('kpi: ', resposta[0].media)
                      }

                      plotarKpiMedia(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }


    function buscarQtdTentativas(idUsuario){
            fetch(`/pontuacaoQuizz/buscarQtdTentativas/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO}}, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].tentativas
                        console.log('kpi: ', resposta[0].tentativas)
                      }

                      plotarKpiQtd(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }

  function buscarAvatar(idUsuario){
            fetch(`/sidebar/buscarAvatar/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].caminhoPersonagem
                        console.log('avatar ', resposta[0].caminhoPersonagem)
                      }

                      plotarAvatar(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }

  function buscarIvy(idUsuario){
            fetch(`/sidebar/buscarIvy/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].caminhoIvy
                        console.log('Ivy ', resposta[0].caminhoIvy)
                      }

                      plotarIvy(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }

  function buscarTeam(idUsuario){
            fetch(`/sidebar/buscarTeam/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].caminhoPersonagem
                        console.log('team ', resposta[0].caminhoPersonagem)
                      }

                      plotarTeam(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }

  function buscarUsername(idUsuario){
            fetch(`/sidebar/buscarUsername/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                    
                      var res = resposta;
                      
                      if (resposta.length > 0) {
                        res = resposta[0].nomeUsuario
                        console.log('username ', resposta[0].nomeUsuario)
                      }

                      plotarUsername(res);

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }



  function plotarKpiPontuacao(resposta){
    console.log('plotando resposta: ', resposta)
    document.getElementById('pontuacao_usuario').innerHTML = `${Number(resposta).toFixed(2)}%`
  }

  function plotarKpiMedia(res){
  console.log('plotando resposta do KPI MEDIA: ', res)
  document.getElementById('pontuacao_site').innerHTML = `${res}%`
  }

  function plotarKpiQtd(res){
  console.log('plotando resposta do KPI Qtd: ', res)
  document.getElementById('tentativas_quiz').innerHTML = `${Number(res)}`
  }

  function plotarAvatar(res){
  console.log('plotando avatar: ', res)
  document.getElementById('img_avatar').src = `${res}`
  }

  function plotarIvy(res){
  console.log('plotando Ivy: ', res)
  document.getElementById('img_ivy').src = `${res}`
  }

   function plotarTeam(res){
  console.log('plotando Ivy: ', res)
  document.getElementById('img_team').src = `${res}`
  }

     function plotarUsername(res){
  console.log('plotando username: ', res)
  document.getElementById('nome_usuario').innerHTML = `${res}`
  }


      function buscarPorcentagens(idUsuario){
            fetch(`/pontuacaoQuizz/buscarPorcentagens/${idUsuario}`, 
            {method: 'POST', body:{idUsuario:sessionStorage.ID_USUARIO} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                      
                      if (resposta.length > 0) {
                        plotarGraficoBarra(resposta)
                      }

                      

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }


      function plotarGraficoBarra(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
         let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
        datasets: [{
          label: '% Pontuação / Data',
          data: [],
          backgroundColor: 'rgba(24, 98, 141, 0.8)',
          borderColor: '#18628D',
          borderWidth: 1,
          barThickness: 70,
        }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
      //  console.log(resposta)
        // console.log(res)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
          for (i = 0; i < resposta.length; i++) {
              var registro = resposta[i];
              const dataJS = new Date(registro.dtQuizz)
                const dataFormatada = dataJS.toLocaleDateString('pt-BR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric' 
  });
              labels.push(dataFormatada);
              // dados.datasets[0].data.push(registro.dtQuizz);
              dados.datasets[0].data.push(Number(registro.pontuacaoConhecimento));
              // console.log(dados.datasets[1].data)
          }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`grafico-pontuacao`),
            config
        );

        // setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }



      function buscarQtdUsuariosIvy(){
            fetch(`/pontuacaoQuizz/buscarQtdUsuariosIvy`, 
            {method: 'POST', body:{} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                      
                      if (resposta.length > 0) {
                        plotarGraficoPizza1(resposta)
                      }

                      

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }


      function plotarGraficoPizza1(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
         let labelsPizza1 = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {labels: labelsPizza1,
    datasets: [{
      label: 'Quantidade de alunos',
      data: [],
      backgroundColor: [
        '#21538e',
        '#5181aa',
        '#143357'    ],
      hoverOffset: 4,
    }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
      //  console.log(resposta)
        // console.log(res)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
          for (i = 0; i < resposta.length; i++) {
              var registro = resposta[i];
              labelsPizza1.push(registro.nomeIvy);
              // dados.datasets[0].data.push(registro.dtQuizz);
              dados.datasets[0].data.push(Number(registro.qtd_usuarios));
              // console.log(dados.datasets[1].data)
          }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labelsPizza1)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config= {
    type: 'pie',
    data: dados,
    options: {
      plugins: {
        legend: {
          position: 'right'
        },
        title: {
          display: true,
          text: 'Usuários em cada Ivy League',
          position: 'top',
          align: 'center',
          font: {
            family: 'Playfair Display',
            size: 20,
          },
        }
      }
    }
  };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`grafico-ivy`),
            config
        );

        // setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }


          function buscarQtdViews(){
            fetch(`/pontuacaoQuizz/buscarQtdViews`, 
            {method: 'POST', body:{} }, 
            { cache: 'no-store' }).then(function (response) {
              if (response.ok) {
                response.json().then(function (resposta) {
                      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                      resposta.reverse();
                      
                      if (resposta.length > 0) {
                        plotarGraficoPizza2(resposta)
                      }

                      

                  });
                } else {
                  console.error('Nenhum dado encontrado ou erro na API');
                  console.log(response)
                }
          })
              .catch(function (error) {
                  console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
              });
  }



      function plotarGraficoPizza2(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
         let labelsPizza2 = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {labels: labelsPizza2,
    datasets: [{
      label: 'Quantidade de alunos',
      data: [],
      backgroundColor: [
        '#21538e',
        '#5181aa',
        '#143357'    ],
      hoverOffset: 4,
    }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
      //  console.log(resposta)
        // console.log(res)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
          for (i = 0; i < resposta.length; i++) {
              var registro = resposta[i];
              labelsPizza2.push(`${registro.qtdViews} views`);
              // dados.datasets[0].data.push(registro.dtQuizz);
              dados.datasets[0].data.push(Number(registro.qtd_usuarios));
              // console.log(dados.datasets[1].data)
          }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labelsPizza2)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config= {
    type: 'pie',
    data: dados,
    options: {
      plugins: {
        legend: {
          position: 'right'
        },
        title: {
          display: true,
          text: 'Quantidade de vezes que a série foi vista',
          position: 'top',
          align: 'center',
          font: {
            family: 'Playfair Display',
            size: 20,
          },
        }
      }
    }
  };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`grafico-views`),
            config
        );

        // setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }

     
  

    buscarMediaPontuacao(idUsuario);

    buscarQtdTentativas(idUsuario)

buscarMaiorPontuacao(idUsuario);
buscarAvatar(idUsuario);
buscarIvy(idUsuario);
buscarTeam(idUsuario);
buscarUsername(idUsuario);
buscarPorcentagens(idUsuario);
buscarQtdUsuariosIvy();
buscarQtdViews();
</script>
